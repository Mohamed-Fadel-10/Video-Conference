<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Video Conference - Test Client</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .status-bar {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e74c3c;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #2ecc71;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .panel h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5rem;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 600;
        }

        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #2ecc71;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #27ae60;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #c0392b;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover:not(:disabled) {
            background: #e67e22;
        }

        .btn-info {
            background: #3498db;
            color: white;
        }

        .btn-info:hover:not(:disabled) {
            background: #2980b9;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #7f8c8d;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .video-container {
            position: relative;
            background: #000;
            border-radius: 15px;
            overflow: hidden;
            aspect-ratio: 16/9;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }

        .video-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            padding: 15px;
            color: white;
        }

        .video-name {
            font-weight: 600;
            font-size: 14px;
        }

        .video-status {
            display: flex;
            gap: 10px;
            margin-top: 5px;
        }

        .video-badge {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 12px;
            background: rgba(255,255,255,0.2);
        }

        .video-badge.muted {
            background: rgba(231, 76, 60, 0.8);
        }

        .video-badge.you {
            background: rgba(102, 126, 234, 0.8);
        }

        .video-badge.sharing {
            background: rgba(243, 156, 18, 0.8);
            animation: pulse 1.5s infinite;
        }

        .video-badge.raised-hand {
            background: rgba(155, 89, 182, 0.8);
            animation: pulse 1s infinite;
        }

        .participants-list {
            display: grid;
            gap: 10px;
            max-height: 200px;
            overflow-y: auto;
        }

        .participant-card {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .participant-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 20px;
        }

        .participant-info {
            flex: 1;
        }

        .participant-name {
            font-weight: 600;
            color: #333;
        }

        .participant-status {
            display: flex;
            gap: 10px;
            margin-top: 5px;
        }

        .status-badge {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 12px;
            background: #e0e0e0;
            color: #666;
        }

        .status-badge.host {
            background: #667eea;
            color: white;
        }

        .status-badge.active {
            background: #2ecc71;
            color: white;
        }

        .status-badge.sharing {
            background: #f39c12;
            color: white;
            animation: pulse 2s infinite;
        }

        .status-badge.raised-hand {
            background: #9b59b6;
            color: white;
            animation: pulse 1s infinite;
        }

        .console {
            background: #1e1e1e;
            color: #d4d4d4;
            border-radius: 10px;
            padding: 20px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .console-line {
            margin-bottom: 8px;
            padding: 5px;
            border-radius: 3px;
        }

        .console-line.success {
            color: #4ec9b0;
        }

        .console-line.error {
            color: #f48771;
        }

        .console-line.info {
            color: #9cdcfe;
        }

        .console-line.warning {
            color: #dcdcaa;
        }

        .meeting-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .meeting-info h3 {
            margin-bottom: 10px;
        }

        .meeting-code {
            font-size: 24px;
            font-weight: bold;
            letter-spacing: 3px;
            font-family: monospace;
        }

        .join-requests {
            max-height: 200px;
            overflow-y: auto;
        }

        .join-request-card {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #f39c12;
        }

        .join-request-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .screen-share-requests {
            max-height: 200px;
            overflow-y: auto;
        }

        .screen-share-request-card {
            background: #d1ecf1;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #17a2b8;
        }

        .raise-hand-requests {
            max-height: 200px;
            overflow-y: auto;
        }

        .raise-hand-request-card {
            background: #f0e6ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #9b59b6;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 15px;
            opacity: 0.3;
        }

        /* Chat Styles */
        .chat-container {
            display: grid;
            grid-template-rows: auto 1fr auto;
            height: 400px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }

        .chat-header {
            background: #667eea;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-messages {
            padding: 15px;
            overflow-y: auto;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 300px;
        }

        .message {
            padding: 10px 15px;
            border-radius: 15px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .message.sent {
            background: #667eea;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }

        .message.received {
            background: white;
            color: #333;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
            border: 1px solid #e0e0e0;
        }

        .message.private {
            border: 2px solid #9b59b6;
        }

        .message.system {
            background: #f39c12;
            color: white;
            align-self: center;
            text-align: center;
            font-style: italic;
        }

        .message-header {
            font-size: 12px;
            margin-bottom: 5px;
            opacity: 0.8;
        }

        .message-content {
            margin-bottom: 5px;
        }

        .message-file {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
            margin-top: 5px;
        }

        .message-file a {
            color: inherit;
            text-decoration: none;
        }

        .message-file a:hover {
            text-decoration: underline;
        }

        .chat-input {
            display: flex;
            gap: 10px;
            padding: 15px;
            background: white;
            border-top: 1px solid #e0e0e0;
        }

        .chat-input input,
        .chat-input textarea {
            flex: 1;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 20px;
            resize: none;
        }

        .chat-input button {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            background: #667eea;
            color: white;
            cursor: pointer;
        }

        .chat-input button:hover {
            background: #5a6fd8;
        }

        .chat-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .chat-controls select {
            padding: 8px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }

        .file-upload {
            display: none;
        }

        .file-upload-label {
            padding: 8px 15px;
            background: #95a5a6;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
        }

        .file-upload-label:hover {
            background: #7f8c8d;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .turn-status {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 12px;
        }

        .turn-status.success {
            background: #d4edda;
            color: #155724;
        }

        .turn-status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .screen-share-controls {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #f39c12;
        }

        .screen-share-controls h4 {
            color: #f39c12;
            margin-bottom: 10px;
        }

        .current-sharer {
            background: #fff3cd;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #f39c12;
        }

        .raise-hand-controls {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #9b59b6;
        }

        .raise-hand-controls h4 {
            color: #9b59b6;
            margin-bottom: 10px;
        }

        .chat-controls-panel {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #3498db;
        }

        .chat-controls-panel h4 {
            color: #3498db;
            margin-bottom: 10px;
        }

        /*Meeting Settings*/
        /* Add to the existing CSS */
.settings-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}

@media (max-width: 768px) {
    .settings-grid {
        grid-template-columns: 1fr;
    }
}

.settings-section {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 10px;
    border-left: 4px solid #667eea;
}

.settings-section h3 {
    color: #667eea;
    margin-bottom: 15px;
    font-size: 1.1rem;
    border-bottom: 1px solid #e0e0e0;
    padding-bottom: 8px;
}

.settings-display {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
}

.setting-item {
    background: white;
    padding: 15px;
    border-radius: 8px;
    border: 1px solid #e0e0e0;
    text-align: center;
}

.setting-icon {
    font-size: 24px;
    margin-bottom: 8px;
}

.setting-label {
    font-weight: 600;
    color: #333;
    margin-bottom: 5px;
}

.setting-value {
    font-size: 14px;
    color: #666;
}

.setting-value.enabled {
    color: #2ecc71;
    font-weight: 600;
}

.setting-value.disabled {
    color: #e74c3c;
    font-weight: 600;
}

.settings-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    margin-left: 8px;
}

.settings-badge.enabled {
    background: #d4edda;
    color: #155724;
}

.settings-badge.disabled {
    background: #f8d7da;
    color: #721c24;
}

.host-only {
    border-left: 4px solid #f39c12 !important;
}

.host-only h3 {
    color: #f39c12 !important;
}

.settings-warning {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    color: #856404;
    padding: 10px 15px;
    border-radius: 8px;
    margin-bottom: 15px;
    font-size: 14px;
}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé• WebSocket Video Conference</h1>
            <p>Test Client with Screen Sharing, Raise Hand & Chat</p>
        </div>

        <div class="status-bar">
            <div class="status-indicator">
                <div class="status-dot" id="statusDot"></div>
                <strong id="statusText">Disconnected</strong>
            </div>
            <div class="btn-group">
                <button class="btn btn-success" id="connectBtn" onclick="connect()">Connect</button>
                <button class="btn btn-danger" id="disconnectBtn" onclick="disconnect()" disabled>Disconnect</button>
                <button class="btn btn-warning" onclick="debugState()">üêõ Debug</button>
                <button class="btn btn-info" onclick="refreshTurnConfig()">üîÑ Reload TURN</button>
            </div>
        </div>

        <div id="turnStatus" class="turn-status" style="display:none;"></div>

        <div class="main-grid">
            <div class="panel">
                <h2>üë§ User Configuration</h2>
                <div class="form-group">
                    <label>User ID</label>
                    <input type="text" id="userId" value="11111111-1111-1111-1111-111111111111">
                </div>
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="userName" value="Alice Host">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="userEmail" value="alice@example.com">
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="isHost" checked>
                    <label for="isHost">Host User</label>
                </div>
            </div>

            <div class="panel">
                <h2>üé¨ Meeting Actions</h2>
                <div class="form-group">
                    <label>Meeting Title</label>
                    <input type="text" id="meetingTitle" value="Team Standup Meeting">
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="waitingList">
                    <label for="waitingList">Enable Waiting List</label>
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="createMeeting()" disabled id="createBtn">Create Meeting</button>
                </div>

                <div class="form-group" style="margin-top: 20px;">
                    <label>Meeting ID (to join)</label>
                    <input type="text" id="meetingIdInput" placeholder="Enter meeting ID">
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="joinMeeting()" disabled id="joinBtn">Join Meeting</button>
                    <button class="btn btn-danger" onclick="leaveMeeting()" disabled id="leaveBtn">Leave Meeting</button>
                </div>
            </div>
        </div>

        <div id="meetingInfoPanel" style="display: none;">
            <div class="meeting-info">
                <h3>üìç Current Meeting</h3>
                <div><strong>Title:</strong> <span id="currentMeetingTitle"></span></div>
                <div><strong>Code:</strong> <span class="meeting-code" id="currentMeetingCode"></span></div>
                <div><strong>ID:</strong> <span id="currentMeetingId" style="font-family: monospace; font-size: 12px;"></span></div>
            </div>
        </div>


<!-- Meeting Settings Panel -->
<div id="meetingSettingsPanel" class="panel" style="display: none;">
    <h2>‚öôÔ∏è Meeting Settings</h2>
    
    <div class="settings-grid">
        <!-- Basic Settings -->
        <div class="settings-section">
            <h3>üé¨ Basic Settings</h3>
            
            <div class="checkbox-group">
                <input type="checkbox" id="settingEnableCamera" checked>
                <label for="settingEnableCamera">Enable Camera for Participants</label>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="settingEnableMic" checked>
                <label for="settingEnableMic">Enable Microphone for Participants</label>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="settingEnableRaiseHand" checked>
                <label for="settingEnableRaiseHand">Enable Raise Hand Feature</label>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="settingEnableScreenSharing" checked>
                <label for="settingEnableScreenSharing">Enable Screen Sharing</label>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="settingEnableChat" checked>
                <label for="settingEnableChat">Enable Chat</label>
            </div>
        </div>

        <!-- Advanced Settings -->
        <div class="settings-section">
            <h3>üîß Advanced Settings</h3>
            
            <div class="checkbox-group">
                <input type="checkbox" id="settingWaitingList" checked>
                <label for="settingWaitingList">Enable Waiting Room</label>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="settingAllowUnmute" checked>
                <label for="settingAllowUnmute">Allow Participants to Unmute</label>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="settingMuteOnEntry">
                <label for="settingMuteOnEntry">Mute All Participants on Entry</label>
            </div>
            
            <div class="form-group">
                <label for="settingMaxParticipants">Max Participants</label>
                <input type="number" id="settingMaxParticipants" min="1" max="1000" value="100">
            </div>
        </div>
    </div>

    <div class="btn-group" style="margin-top: 20px;">
        <button class="btn btn-primary" onclick="updateMeetingSettings()" id="updateSettingsBtn">üíæ Update Settings</button>
        <button class="btn btn-secondary" onclick="resetSettingsToDefault()">üîÑ Reset to Default</button>
    </div>
</div>

<!-- Current Settings Display for Participants -->
<div id="currentSettingsPanel" class="panel" style="display: none;">
    <h2>‚öôÔ∏è Current Meeting Settings</h2>
    <div class="settings-display" id="settingsDisplay">
        <div class="empty-state">
            <svg fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"/>
            </svg>
            <p>Meeting settings will appear here</p>
        </div>
    </div>
</div>
        <!-- Screen Share Controls -->
        <div id="screenShareControls" class="screen-share-controls" style="display: none;">
            <h4>üñ•Ô∏è Screen Sharing</h4>
            <div class="btn-group">
                <button class="btn btn-warning" onclick="requestScreenShare()" id="requestShareBtn">Request to Share Screen</button>
                <button class="btn btn-secondary" onclick="stopScreenShare()" id="stopShareBtn" disabled>Stop Sharing</button>
            </div>
            <div id="currentSharerInfo" class="current-sharer" style="display: none;">
                <strong>Currently Sharing:</strong> <span id="currentSharerName"></span>
            </div>
        </div>

        <!-- Raise Hand Controls -->
        <div id="raiseHandControls" class="raise-hand-controls" style="display: none;">
            <h4>‚úã Raise Hand</h4>
            <div class="btn-group">
                <button class="btn btn-info" onclick="raiseHand()" id="raiseHandBtn">‚úã Raise Hand</button>
                <button class="btn btn-secondary" onclick="lowerHand()" id="lowerHandBtn" disabled>Lower Hand</button>
            </div>
        </div>

        <!-- Chat Controls -->
        <div id="chatControls" class="chat-controls-panel" style="display: none;">
            <h4>üí¨ Meeting Chat</h4>
            <div class="chat-container">
                <div class="chat-header">
                    <strong>Meeting Chat</strong>
                    <span id="chatStatus">Connected</span>
                </div>
                <div class="chat-messages" id="chatMessages">
                    <div class="message system">
                        Welcome to the meeting chat! Start typing to send messages.
                    </div>
                </div>
                <div class="chat-input">
                    <textarea id="chatInput" placeholder="Type your message..." rows="2"></textarea>
                    <button onclick="sendChatMessage()">Send</button>
                </div>
                <div class="chat-controls">
                    <select id="messageType">
                        <option value="text">Text Message</option>
                        <option value="file">File Attachment</option>
                    </select>
                    <select id="messageTarget">
                        <option value="all">Everyone</option>
                    </select>
                    <input type="file" id="fileUpload" class="file-upload" onchange="handleFileUpload()">
                    <label for="fileUpload" class="file-upload-label">üìé Attach File</label>
                </div>
            </div>
        </div>

        <div class="panel">
            <h2>üìπ Video Streams</h2>
            <div class="checkbox-group" style="margin-bottom: 15px;">
                <input type="checkbox" id="cameraEnabled" onchange="toggleCamera()">
                <label for="cameraEnabled">üìπ Camera</label>
                <input type="checkbox" id="micEnabled" onchange="toggleMicrophone()">
                <label for="micEnabled">üé§ Microphone</label>
            </div>
            <div class="video-grid" id="videoGrid">
                <div class="empty-state">
                    <svg fill="currentColor" viewBox="0 0 20 20">
                        <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z"/>
                    </svg>
                    <p>No video streams yet. Enable camera to start.</p>
                </div>
            </div>
        </div>

        <div class="main-grid">
            <div class="panel">
                <h2>üë• Participants (<span id="participantCount">0</span>)</h2>
                <div class="participants-list" id="participantsList">
                    <div class="empty-state">
                        <svg fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
                        </svg>
                        <p>No participants yet</p>
                    </div>
                </div>
            </div>

            <div class="panel">
                <h2>üìã Join Requests (<span id="requestCount">0</span>)</h2>
                <div class="join-requests" id="joinRequestsList">
                    <div class="empty-state">
                        <svg fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z" clip-rule="evenodd"/>
                        </svg>
                        <p>No pending requests</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Screen Share Requests Panel -->
        <div class="panel" id="screenShareRequestsPanel" style="display: none;">
            <h2>üñ•Ô∏è Screen Share Requests (<span id="screenShareRequestCount">0</span>)</h2>
            <div class="screen-share-requests" id="screenShareRequestsList">
                <div class="empty-state">
                    <svg fill="currentColor" viewBox="0 0 20 20">
                        <path d="M2.707 1.5A1 1 0 002 2.5v15A1.5 1.5 0 003.5 19h14a1.5 1.5 0 001.5-1.5v-15a1 1 0 00-.293-.707l-15-15zM3.5 0A1.5 1.5 0 002 1.5v15A1.5 1.5 0 003.5 18h14a1.5 1.5 0 001.5-1.5v-15A1.5 1.5 0 0017.5 0h-14z"/>
                        <path d="M13 13h2a1 1 0 001-1V8a1 1 0 00-1-1h-2a1 1 0 00-1 1v4a1 1 0 001 1zM7 13h2a1 1 0 001-1V8a1 1 0 00-1-1H7a1 1 0 00-1 1v4a1 1 0 001 1z"/>
                    </svg>
                    <p>No screen share requests</p>
                </div>
            </div>
        </div>

        <!-- Raise Hand Notifications Panel -->
        <div class="panel" id="raiseHandPanel" style="display: none;">
            <h2>‚úã Raised Hands (<span id="raisedHandCount">0</span>)</h2>
            <div class="raise-hand-requests" id="raisedHandsList">
                <div class="empty-state">
                    <svg fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v3.586L7.707 9.293a1 1 0 00-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 10.586V7z" clip-rule="evenodd"/>
                    </svg>
                    <p>No raised hands</p>
                </div>
            </div>
        </div>

        <div class="panel">
            <h2>üìü Console Log</h2>
            <div class="console" id="console"></div>
        </div>
    </div>

    <script>
         let ws = null;
        let currentMeetingId = null;
        let participants = new Map();
        let joinRequests = new Map();
        let screenShareRequests = new Map();
        let raisedHands = new Map();
        let localStream = null;
        let screenStream = null;
        let peerConnections = new Map();
        let currentScreenSharer = null;
        let isScreenSharing = false;
        let isHandRaised = false;
        let chatMessages = [];
        let selectedFile = null;
        let uploadedFileId = null;
        let isUploading = false;
        let currentMeetingSettings = null;
        let isHost = false;
        
        function initializeSettings() {
            currentMeetingSettings = {
                waiting_list: true,
                enable_camera: true,
                enable_mic: true,
                enable_raise_hand: true,
                enable_share_screen: true,
                enable_chat: true,
                allow_participants_to_unmute: true,
                mute_all_participants_on_entry: false,
                max_participants: 100
    };
}
        // Message type mapping
        const messageTypeMap = {
            'text': 1,
            'image': 2,
            'file': 3,
            'voice': 4,
            'video': 5
        };

        const messageTypeIcons = {
            'text': 'üìù',
            'image': 'üñºÔ∏è',
            'file': 'üìé',
            'voice': 'üéµ',
            'video': 'üé¨'
        };
        
        // CRITICAL FIX: Get userId dynamically, not on page load
         function getMyUserId() {
            return document.getElementById('userId').value;
        }
         function initializeEventListeners() {
            // Message type change
            document.getElementById('messageType').addEventListener('change', function() {
                handleMessageTypeChange(this.value);
            });

            // File upload change
            document.getElementById('fileUpload').addEventListener('change', function(e) {
                handleFileUpload(e);
            });

            // Chat input events
            document.getElementById('chatInput').addEventListener('input', function() {
                updateMessagePreview();
            });

            document.getElementById('chatInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendChatMessage();
                }
            });
        }
function handleMessageTypeChange(messageType) {
            const chatInput = document.getElementById('chatInput');
            const fileUploadLabel = document.getElementById('fileUploadLabel');
            const fileUpload = document.getElementById('fileUpload');
            
            // Reset file state when switching from file type
            if (messageType === 'text' && selectedFile) {
                removeSelectedFile();
            }

            // Update placeholder and file upload visibility
            if (messageType === 'text') {
                chatInput.placeholder = 'Type your message...';
                fileUploadLabel.style.display = 'block';
                fileUploadLabel.textContent = 'üìé Attach File';
                fileUploadLabel.className = 'file-upload-label';
            } else {
                chatInput.placeholder = 'Add a caption (optional)...';
                fileUploadLabel.style.display = 'block';
                fileUploadLabel.textContent = `${messageTypeIcons[messageType]} Select ${messageType}`;
                fileUploadLabel.className = 'file-upload-label';
                
                // Set accept attribute based on message type
                const acceptMap = {
                    'image': 'image/*',
                    'voice': 'audio/*',
                    'video': 'video/*',
                    'file': '*/*'
                };
                fileUpload.accept = acceptMap[messageType] || '*/*';
            }

            updateMessagePreview();
        }
         // Remove selected file
        function removeSelectedFile() {
            selectedFile = null;
            uploadedFileId = null;
            document.getElementById('fileUpload').value = '';
            document.getElementById('fileInfo').style.display = 'none';
            document.getElementById('fileUploadLabel').textContent = 'üìé Attach File';
            document.getElementById('fileUploadLabel').className = 'file-upload-label';
            document.getElementById('uploadProgress').style.display = 'none';
            updateMessagePreview();
        }

        // Dynamic ICE configuration
        let iceServers = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ],
            iceCandidatePoolSize: 10,
            iceTransportPolicy: 'all'
        };

        // Load TURN configuration on startup
        (async function initializeTurnConfig() {
            await loadTurnCredentials();
        })();

        async function loadTurnCredentials() {
            try {
                log('üîÑ Loading TURN credentials from server...', 'info');
                
                const response = await fetch('https://wesal-api.miskit.net/Turn', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const turnData = await response.json();
                log(`‚úÖ TURN credentials loaded`, 'success');
                log(`   Username: ${turnData.username}`, 'info');
                log(`   URLs: ${turnData.urls.length} endpoints`, 'info');

                // Update ICE configuration with TURN credentials
                iceServers = {
                    iceServers: [
                        // Keep Google STUN servers
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' },
                        { urls: 'stun:stun2.l.google.com:19302' },
                        // Add TURN server with credentials
                        {
                            urls: turnData.urls,
                            username: turnData.username,
                            credential: turnData.credential
                        }
                    ],
                    iceCandidatePoolSize: 10,
                    iceTransportPolicy: 'all'
                };

                turnData.urls.forEach(url => {
                    log(`   üìç ${url}`, 'info');
                });

                showTurnStatus('‚úÖ TURN server configured successfully', 'success');
                return true;

            } catch (error) {
                log(`‚ùå Failed to load TURN credentials: ${error.message}`, 'error');
                log(`‚ö†Ô∏è Falling back to STUN-only mode`, 'warning');
                
                showTurnStatus('‚ö†Ô∏è TURN server unavailable - using STUN only', 'error');
                
                // Fallback to STUN only
                iceServers = {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' },
                        { urls: 'stun:stun2.l.google.com:19302' },
                        { urls: 'stun:stun3.l.google.com:19302' },
                        { urls: 'stun:stun4.l.google.com:19302' }
                    ],
                    iceCandidatePoolSize: 5,
                    iceTransportPolicy: 'all'
                };
                
                return false;
            }
        }

        async function refreshTurnConfig() {
            log('========== REFRESHING TURN CONFIG ==========', 'warning');
            await loadTurnCredentials();
            
            // Close and reconnect all peers with new config
            if (currentMeetingId && peerConnections.size > 0) {
                log('üîÑ Reconnecting all peers with new TURN config...', 'info');
                await reconnectAllPeers();
            }
            
            log('===========================================', 'warning');
        }

        function showTurnStatus(message, type) {
            const statusEl = document.getElementById('turnStatus');
            statusEl.textContent = message;
            statusEl.className = `turn-status ${type}`;
            statusEl.style.display = 'block';
            
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 5000);
        }

        // WebSocket Connection
        function connect() {
            const wsUrl = 'wss://wesal-api.miskit.net/ws';
            log(`Connecting to ${wsUrl}...`, 'info');
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                log('‚úÖ Connected to WebSocket server', 'success');
                updateConnectionStatus(true);
                enableButtons(true);
            };
            
            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    log(`üì® ${data.type}`, 'info');
                    handleMessage(data);
                } catch (error) {
                    log(`‚ùå Error parsing message: ${error.message}`, 'error');
                }
            };
            
            ws.onerror = (error) => {
                log(`‚ùå WebSocket Error`, 'error');
                console.error('WebSocket error:', error);
            };
            
            ws.onclose = () => {
                log('üîå Disconnected from server', 'warning');
                updateConnectionStatus(false);
                enableButtons(false);
                ws = null;
            };
        }

        function disconnect() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                if (currentMeetingId) {
                    leaveMeeting();
                }
                ws.close();
            }
        }

        async function requestScreenShare() {
            if (!currentMeetingId) {
                alert('Please join a meeting first!');
                return;
            }

            const userData = getUserData();
            log("user Data", userData);
            console.log("user Data in screen", userData);
            
            if (userData.is_host) {
                log('üñ•Ô∏è Host is starting screen share directly...', 'info');
                await startScreenSharing();
                return;
            }

            const message = {
                type: 'request_to_share_screen',
                user_data: userData,
                meeting_id: currentMeetingId
            };

            ws.send(JSON.stringify(message));
            log('üì§ Requesting to share screen...', 'info');
        }

        async function startScreenSharing() {
            try {
                log('üñ•Ô∏è Starting screen sharing...', 'info');
                
                screenStream = await navigator.mediaDevices.getDisplayMedia({
                    video: {
                        cursor: 'always',
                        displaySurface: 'window'
                    },
                    audio: true
                });

                screenStream.getVideoTracks()[0].onended = () => {
                    log('üñ•Ô∏è Screen sharing stopped by user', 'warning');
                    stopScreenShare();
                };

                // Add screen share video element
                addVideoElement(getMyUserId() + '-screen', screenStream, `${getUserData().name} (Screen)`, true);
                
                // Replace tracks in all peer connections
                await replaceAllTracks(screenStream);
                
                isScreenSharing = true;
                document.getElementById('stopShareBtn').disabled = false;
                document.getElementById('requestShareBtn').disabled = true;
                
                log('‚úÖ Screen sharing started', 'success');
            } catch (error) {
                log(`‚ùå Failed to start screen sharing: ${error.message}`, 'error');
            }
        }

        async function stopScreenShare() {
            if (screenStream) {
                screenStream.getTracks().forEach(track => track.stop());
                screenStream = null;
            }

            // Remove screen share video element
            removeVideoElement(getMyUserId() + '-screen');
            
            // Restore camera tracks
            if (localStream) {
                await replaceAllTracks(localStream);
            }

            isScreenSharing = false;
            document.getElementById('stopShareBtn').disabled = true;
            document.getElementById('requestShareBtn').disabled = false;
            
            log('üñ•Ô∏è Screen sharing stopped', 'info');
        }

        async function replaceAllTracks(newStream) {
            for (const [userId, pc] of peerConnections) {
                try {
                    const senders = pc.getSenders();
                    
                    for (const sender of senders) {
                        if (sender.track) {
                            const newTrack = newStream.getTracks().find(
                                track => track.kind === sender.track.kind
                            );
                            
                            if (newTrack) {
                                await sender.replaceTrack(newTrack);
                                log(`üîÑ Replaced ${newTrack.kind} track for ${userId.substring(0,8)}`, 'info');
                            }
                        }
                    }
                } catch (error) {
                    log(`‚ùå Error replacing tracks for ${userId.substring(0,8)}: ${error.message}`, 'error');
                }
            }
        }

        function handleScreenShareRequest(data) {
            if (!data.request_id) {
                log('‚ùå Screen share request missing request_id', 'error');
                return;
            }

            screenShareRequests.set(data.request_id, {
                id: data.request_id,
                user: data.user_data,
                meetingId: data.meeting_id
            });
            updateScreenShareRequestsList();
            log(`üñ•Ô∏è Screen share request from ${data.user_data.name}`, 'warning');
        }

        function respondToScreenShareRequest(requestId, approved) {
            const request = screenShareRequests.get(requestId);
            if (!request) {
                log('‚ùå Screen share request not found', 'error');
                return;
            }

            const message = {
                type: approved ? 'accept_share_screen' : 'reject_share_screen',
                user_data: getUserData(),
                meeting_id: currentMeetingId,
                target_user_id: request.user.id,
                request_id: requestId  
            };

            ws.send(JSON.stringify(message));
            log(`üì§ ${approved ? 'Approving' : 'Declining'} screen share request from ${request.user.name}...`, 'info');

            screenShareRequests.delete(requestId);
            updateScreenShareRequestsList();
        }

        function updateScreenShareRequestsList() {
            const list = document.getElementById('screenShareRequestsList');
            const count = document.getElementById('screenShareRequestCount');
            const panel = document.getElementById('screenShareRequestsPanel');
            
            count.textContent = screenShareRequests.size;

            if (screenShareRequests.size === 0) {
                list.innerHTML = '<div class="empty-state"><svg fill="currentColor" viewBox="0 0 20 20"><path d="M2.707 1.5A1 1 0 002 2.5v15A1.5 1.5 0 003.5 19h14a1.5 1.5 0 001.5-1.5v-15a1 1 0 00-.293-.707l-15-15zM3.5 0A1.5 1.5 0 002 1.5v15A1.5 1.5 0 003.5 18h14a1.5 1.5 0 001.5-1.5v-15A1.5 1.5 0 0017.5 0h-14z"/><path d="M13 13h2a1 1 0 001-1V8a1 1 0 00-1-1h-2a1 1 0 00-1 1v4a1 1 0 001 1zM7 13h2a1 1 0 001-1V8a1 1 0 00-1-1H7a1 1 0 00-1 1v4a1 1 0 001 1z"/></svg><p>No screen share requests</p></div>';
                panel.style.display = 'none';
                return;
            }

            panel.style.display = 'block';
            list.innerHTML = '';
            
            screenShareRequests.forEach(req => {
                const card = document.createElement('div');
                card.className = 'screen-share-request-card';
                card.innerHTML = `
                    <div><strong>${req.user.name}</strong> wants to share screen</div>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">User ID: ${req.user.id}</div>
                    <div class="join-request-actions">
                        <button class="btn btn-success" onclick="respondToScreenShareRequest('${req.id}', true)">‚úì Allow</button>
                        <button class="btn btn-danger" onclick="respondToScreenShareRequest('${req.id}', false)">‚úó Deny</button>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        function updateScreenShareStatus(userId, started) {
            if (started) {
                currentScreenSharer = userId;
                const sharerInfo = document.getElementById('currentSharerInfo');
                const sharerName = document.getElementById('currentSharerName');
                
                const participant = participants.get(userId) || { name: 'Unknown User' };
                sharerName.textContent = participant.name;
                sharerInfo.style.display = 'block';
                
                // Update participant status
                if (participants.has(userId)) {
                    const p = participants.get(userId);
                    p.is_sharing = true;
                    participants.set(userId, p);
                }
                
                log(`üñ•Ô∏è ${participant.name} started screen sharing`, 'success');
            } else {
                currentScreenSharer = null;
                document.getElementById('currentSharerInfo').style.display = 'none';
                
                // Update participant status
                if (participants.has(userId)) {
                    const p = participants.get(userId);
                    p.is_sharing = false;
                    participants.set(userId, p);
                }
                
                log(`üñ•Ô∏è Screen sharing stopped`, 'info');
            }
            
            updateParticipantsList();
        }

        // Raise Hand Functions
        function raiseHand() {
            if (!currentMeetingId) {
                alert('Please join a meeting first!');
                return;
            }

            const message = {
                type: 'user_raise_hand',
                user_data: getUserData(),
                meeting_id: currentMeetingId,
                is_raised: true
            };

            ws.send(JSON.stringify(message));
            log('‚úã Raising hand...', 'info');
            
            isHandRaised = true;
            document.getElementById('raiseHandBtn').disabled = true;
            document.getElementById('lowerHandBtn').disabled = false;
        }

        function lowerHand() {
            if (!currentMeetingId) {
                return;
            }

            const message = {
                type: 'user_raise_hand',
                user_data: getUserData(),
                meeting_id: currentMeetingId,
                is_raised: false
            };

            ws.send(JSON.stringify(message));
            log('‚úã Lowering hand...', 'info');
            
            isHandRaised = false;
            document.getElementById('raiseHandBtn').disabled = false;
            document.getElementById('lowerHandBtn').disabled = true;
            
            // Remove from raised hands list
            raisedHands.delete(getMyUserId());
            updateRaisedHandsList();
        }

        function handleRaiseHandNotification(data) {
            if (data.is_raised) {
                raisedHands.set(data.user_data.id, {
                    user: data.user_data,
                    meetingId: data.meeting_id,
                    timestamp: new Date()
                });
                log(`‚úã ${data.user_data.name} raised hand`, 'warning');
            } else {
                raisedHands.delete(data.user_data.id);
                log(`‚úã ${data.user_data.name} lowered hand`, 'info');
            }
            
            updateRaisedHandsList();
            
            // Update participant status
            if (participants.has(data.user_data.id)) {
                const p = participants.get(data.user_data.id);
                p.is_raised = data.is_raised;
                participants.set(data.user_data.id, p);
            }
            
            updateParticipantsList();
        }

        function updateRaisedHandsList() {
            const list = document.getElementById('raisedHandsList');
            const count = document.getElementById('raisedHandCount');
            const panel = document.getElementById('raiseHandPanel');
            
            count.textContent = raisedHands.size;

            if (raisedHands.size === 0) {
                list.innerHTML = '<div class="empty-state"><svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v3.586L7.707 9.293a1 1 0 00-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 10.586V7z" clip-rule="evenodd"/></svg><p>No raised hands</p></div>';
                panel.style.display = 'none';
                return;
            }

            panel.style.display = 'block';
            list.innerHTML = '';
            
            raisedHands.forEach((hand, userId) => {
                const card = document.createElement('div');
                card.className = 'raise-hand-request-card';
                card.innerHTML = `
                    <div><strong>${hand.user.name}</strong> raised hand</div>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">
                        ${new Date(hand.timestamp).toLocaleTimeString()}
                    </div>
                `;
                list.appendChild(card);
            });
        }

        // Chat Functions
    // Chat Functions
 // Send chat message
        async function sendChatMessage() {
            if (!currentMeetingId) {
                alert('Please join a meeting first!');
                return;
            }

            if (isUploading) {
                alert('Please wait for file upload to complete');
                return;
            }

            const messageInput = document.getElementById('chatInput');
            const messageTypeSelect = document.getElementById('messageType');
            const messageType = messageTypeSelect.value;
            const targetSelect = document.getElementById('messageTarget');
            const targetUserId = targetSelect.value !== 'all' ? targetSelect.value : null;
            const content = messageInput.value.trim();

            // Validation
            if (messageType === 'text' && !content) {
                alert('Please enter a message');
                return;
            }

            if (messageType !== 'text' && !selectedFile) {
                alert('Please select a file first');
                return;
            }

            if (messageType !== 'text' && !uploadedFileId) {
                alert('Please wait for file upload to complete');
                return;
            }

            try {
                const message = {
                    type: 'send_message',
                    meeting_id: currentMeetingId,
                    from: getMyUserId(),
                    to_target_user: targetUserId,
                    content: content,
                    message_type: messageTypeMap[messageType],
                    file_id: messageType !== 'text' ? uploadedFileId : null
                };

                console.log('üì§ Sending message:', message);
                ws.send(JSON.stringify(message));

                // Log success message
                if (messageType === 'text') {
                    log(`‚úÖ Sent text message${targetUserId ? ' privately' : ' to everyone'}: "${content}"`, 'success');
                } else {
                    const fileInfo = `${selectedFile.name} (${formatFileSize(selectedFile.size)})`;
                    const captionInfo = content ? ` with caption: "${content}"` : '';
                    log(`‚úÖ Sent ${messageType}${targetUserId ? ' privately' : ' to everyone'}: ${fileInfo}${captionInfo}`, 'success');
                }

                // Reset form
                messageInput.value = '';
                if (messageType !== 'text') {
                    removeSelectedFile();
                }
                document.getElementById('messagePreview').style.display = 'none';

            } catch (error) {
                console.error('‚ùå Error sending message:', error);
                log(`‚ùå Failed to send message: ${error.message}`, 'error');
            }
        }

// ‚úÖ ÿØÿßŸÑÿ© ŸÑÿ™ÿ≠ŸàŸäŸÑ File ÿ•ŸÑŸâ base64 string
function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
            // ÿ•ÿ≤ÿßŸÑÿ© data URL prefix ÿ•ÿ∞ÿß Ÿàÿ¨ÿØ
            const base64 = reader.result.toString().replace(/^data:.*;base64,/, '');
            resolve(base64);
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

// ‚úÖ ÿØÿßŸÑÿ© ŸÖÿ≥ÿßÿπÿØÿ© ŸÑÿ™ÿ≠ŸàŸäŸÑ File ÿ•ŸÑŸâ ArrayBuffer
function fileToArrayBuffer(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsArrayBuffer(file);
    });
}
function normalizeMessageType(messageType) {
    if (!messageType) return 'text';
    
    // ÿ™ÿ≠ŸàŸäŸÑ ÿ•ŸÑŸâ ÿ≥ÿ™ÿ±ŸäŸÜÿ¨ ŸÑŸÑÿ™ÿπÿßŸÖŸÑ ŸÖÿπ ÿßŸÑÿ£ÿ±ŸÇÿßŸÖ ŸàÿßŸÑŸÜÿµŸàÿµ
    const typeStr = messageType.toString().toLowerCase().trim();
    
    if (typeStr === 'text' || typeStr === '1' || typeStr === 'message') return 'text';
    if (typeStr === 'file' || typeStr === '2' || typeStr === 'attachment') return 'file';
    
    console.warn('Unknown message type:', messageType, 'defaulting to text');
    return 'text'; // ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä
}

        // Handle file upload
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const messageType = document.getElementById('messageType').value;
            
            // Auto-switch to appropriate message type based on file
            if (messageType === 'text') {
                const fileType = file.type.split('/')[0];
                const typeMap = {
                    'image': 'image',
                    'audio': 'voice',
                    'video': 'video'
                };
                const detectedType = typeMap[fileType] || 'file';
                document.getElementById('messageType').value = detectedType;
                handleMessageTypeChange(detectedType);
            }

            selectedFile = file;
            displayFileInfo(file);
            updateMessagePreview();
            
            // Auto-upload file
            uploadFile();
        }
         // Upload file to server
        async function uploadFile() {
            if (!selectedFile || !currentMeetingId) {
                log('‚ùå Please select a file and join a meeting first', 'error');
                return;
            }

            if (isUploading) {
                log('‚ö†Ô∏è File upload already in progress', 'warning');
                return;
            }

            isUploading = true;
            const fileUploadLabel = document.getElementById('fileUploadLabel');
            fileUploadLabel.className = 'file-upload-label uploading';
            fileUploadLabel.textContent = '‚è≥ Uploading...';

            showUploadProgress(0, 'Starting upload...');

            try {
                const formData = new FormData();
                formData.append('File', selectedFile);
                formData.append('MeetingId', currentMeetingId);
                formData.append('UserId', getMyUserId());

                log(`üì§ Uploading ${selectedFile.name} (${formatFileSize(selectedFile.size)})...`, 'info');

                const xhr = new XMLHttpRequest();
                
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percentComplete = (e.loaded / e.total) * 100;
                        showUploadProgress(percentComplete, `Uploading... ${Math.round(percentComplete)}%`);
                    }
                });

                const uploadPromise = new Promise((resolve, reject) => {
                    xhr.onload = () => {
                        if (xhr.status === 200) {
                            try {
                                const response = JSON.parse(xhr.responseText);
                                resolve(response);
                            } catch (e) {
                                reject(new Error('Invalid server response'));
                            }
                        } else {
                            reject(new Error(`Upload failed: ${xhr.status} ${xhr.statusText}`));
                        }
                    };

                    xhr.onerror = () => reject(new Error('Network error during upload'));
                    xhr.ontimeout = () => reject(new Error('Upload timeout'));
                });

                xhr.open('POST', 'https://localhost:7190/api/Files/upload');
                xhr.send(formData);

                const response = await uploadPromise;
                uploadedFileId = response.fileId;
                
                showUploadProgress(100, 'Upload complete!');
                log(`‚úÖ File uploaded successfully: ${selectedFile.name} (ID: ${uploadedFileId})`, 'success');
                
                fileUploadLabel.className = 'file-upload-label has-file';
                fileUploadLabel.textContent = '‚úÖ Uploaded';

                // Auto-focus chat input after successful upload
                document.getElementById('chatInput').focus();

            } catch (error) {
                log(`‚ùå Upload failed: ${error.message}`, 'error');
                showUploadProgress(0, 'Upload failed');
                fileUploadLabel.className = 'file-upload-label';
                fileUploadLabel.textContent = 'üìé Retry Upload';
            } finally {
                isUploading = false;
                // Hide progress after 2 seconds
                setTimeout(() => {
                    document.getElementById('uploadProgress').style.display = 'none';
                }, 2000);
            }
        }

         // Show upload progress
        function showUploadProgress(percent, status) {
            const progressEl = document.getElementById('uploadProgress');
            const progressFill = document.getElementById('progressFill');
            const uploadStatus = document.getElementById('uploadStatus');
            
            progressEl.style.display = 'block';
            progressFill.style.width = `${percent}%`;
            uploadStatus.textContent = status;
        }

         // Update message preview
        function updateMessagePreview() {
            const preview = document.getElementById('messagePreview');
            const previewContent = document.getElementById('previewContent');
            const previewType = document.getElementById('previewType');
            const messageType = document.getElementById('messageType').value;
            const chatInput = document.getElementById('chatInput');

            let content = chatInput.value.trim();
            let typeText = messageType.charAt(0).toUpperCase() + messageType.slice(1);

            if (messageType === 'text') {
                if (!content) {
                    preview.style.display = 'none';
                    return;
                }
                previewContent.textContent = content.length > 50 ? content.substring(0, 50) + '...' : content;
            } else {
                if (selectedFile) {
                    content = content || 'No caption';
                    previewContent.textContent = `${selectedFile.name} - ${content}`;
                } else {
                    preview.style.display = 'none';
                    return;
                }
            }

            previewType.textContent = typeText;
            preview.style.display = 'block';
        }

         // Display file information
        function displayFileInfo(file) {
            const fileInfo = document.getElementById('fileInfo');
            const fileName = document.getElementById('fileName');
            const fileSize = document.getElementById('fileSize');
            const fileIcon = document.getElementById('fileIcon');
            const fileUploadLabel = document.getElementById('fileUploadLabel');

            const fileType = file.type.split('/')[0];
            const iconMap = {
                'image': 'üñºÔ∏è',
                'audio': 'üéµ',
                'video': 'üé¨'
            };

            fileIcon.textContent = iconMap[fileType] || 'üìé';
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            fileInfo.style.display = 'flex';
            
            fileUploadLabel.textContent = 'üìé Change File';
            fileUploadLabel.className = 'file-upload-label has-file';
        }
        // Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
function resetFileState() {
    selectedFile = null;
    document.getElementById('fileUpload').value = '';
    const fileLabel = document.querySelector('.file-upload-label');
    fileLabel.textContent = 'üìé Attach File';
    fileLabel.style.background = '#95a5a6';
    
}
 // Convert message type number to string
        function getMessageTypeString(typeNumber) {
            const typeMap = {
                1: 'text',
                2: 'image',
                3: 'file',
                4: 'voice',
                5: 'video'
            };
            return typeMap[typeNumber] || 'text';
        }
   // Handle received message
        function handleMessageReceived(data) {
            const isMe = data.sender_id === getMyUserId();
            const isPrivate = data.is_private;
            const senderName = data.sender_name || 'Unknown';
            
            // Convert message type number to string
            const messageType = getMessageTypeString(data.message_type);
            
            console.log("üì® Received message:", {
                content: data.content,
                message_type: messageType,
                file_name: data.file_name,
                file_url: data.file_url,
                sender: senderName
            });

            // Add to chat messages array
            chatMessages.push({
                id: data.message_id,
                senderId: data.sender_id,
                senderName: senderName,
                content: data.content,
                isPrivate: isPrivate,
                messageType: messageType,
                fileUrl: data.file_url,
                fileName: data.file_name,
                sentAt: data.sent_at || new Date(),
                isMe: isMe
            });

            // Update chat UI
            updateChatMessages();
            
            // Log the message
            let logMessage = `üí¨ ${isPrivate ? 'üîí Private from ' : ''}${senderName}: `;
            
            if (messageType === 'text') {
                logMessage += data.content || '(Empty message)';
            } else {
                logMessage += `${messageTypeIcons[messageType]} ${data.file_name || 'File'}`;
                if (data.content) {
                    logMessage += ` - "${data.content}"`;
                }
            }
            
            log(logMessage, isMe ? 'info' : 'success');
        }


        function updateChatParticipants() {
            const targetSelect = document.getElementById('messageTarget');
            
            // Keep the current selection
            const currentSelection = targetSelect.value;
            
            // Clear and add "Everyone" option
            targetSelect.innerHTML = '<option value="all">Everyone</option>';
            
            // Add all participants as private message targets
            participants.forEach(participant => {
                if (participant.id !== getMyUserId()) {
                    const option = document.createElement('option');
                    option.value = participant.id;
                    option.textContent = `üîí ${participant.name}`;
                    targetSelect.appendChild(option);
                }
            });
            
            // Restore selection if possible
            if (currentSelection && Array.from(targetSelect.options).some(opt => opt.value === currentSelection)) {
                targetSelect.value = currentSelection;
            }
        }

        // WebRTC Functions
        async function initLocalStream() {
            try {
                const constraints = {
                    video: document.getElementById('cameraEnabled').checked,
                    audio: document.getElementById('micEnabled').checked
                };

                if (!constraints.video && !constraints.audio) {
                    log('‚ö†Ô∏è Enable camera or mic first', 'warning');
                    return null;
                }

                localStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                localStream.getTracks().forEach(track => {
                    log(`‚úÖ Got ${track.kind} track: ${track.label}`, 'success');
                });
                
                addVideoElement(getMyUserId(), localStream, document.getElementById('userName').value, true);
                return localStream;
            } catch (error) {
                log(`‚ùå Failed to get media: ${error.message}`, 'error');
                
                if (error.name === 'NotAllowedError') {
                    alert('Camera/Microphone access denied. Please allow access and try again.');
                } else if (error.name === 'NotFoundError') {
                    alert('No camera or microphone found on this device.');
                }
                
                return null;
            }
        }

        async function toggleCamera() {
            const enabled = document.getElementById('cameraEnabled').checked;
            
            if (localStream) {
                const videoTrack = localStream.getVideoTracks()[0];
                if (videoTrack) {
                    videoTrack.enabled = enabled;
                    log(`üìπ Camera ${enabled ? 'enabled' : 'disabled'}`, 'info');
                } else if (enabled) {
                    log('üìπ Getting new video track...', 'info');
                    stopLocalStream();
                    await initLocalStream();
                    if (currentMeetingId) await reconnectAllPeers();
                }
            } else if (enabled) {
                await initLocalStream();
            }

            if (currentMeetingId) updateMediaState();
        }

        async function toggleMicrophone() {
            const enabled = document.getElementById('micEnabled').checked;
            
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                if (audioTrack) {
                    audioTrack.enabled = enabled;
                    log(`üé§ Microphone ${enabled ? 'enabled' : 'disabled'}`, 'info');
                } else if (enabled) {
                    log('üé§ Getting new audio track...', 'info');
                    stopLocalStream();
                    await initLocalStream();
                    if (currentMeetingId) await reconnectAllPeers();
                }
            } else if (enabled) {
                await initLocalStream();
            }

            if (currentMeetingId) updateMediaState();
        }

        async function reconnectAllPeers() {
            log('üîÑ Reconnecting all peers...', 'info');
            
            peerConnections.forEach((pc, userId) => {
                pc.close();
                removeVideoElement(userId);
            });
            peerConnections.clear();
            
            // Wait a bit for connections to close
            await new Promise(resolve => setTimeout(resolve, 500));
            
            for (const [userId, participant] of participants) {
                await makeOffer(userId);
            }
        }

        async function createPeerConnection(userId) {
            if (peerConnections.has(userId)) {
                const existingPc = peerConnections.get(userId);
                if (existingPc.connectionState !== 'failed' && existingPc.connectionState !== 'closed') {
                    log(`‚ö†Ô∏è Peer connection already exists for ${userId.substring(0,8)}`, 'warning');
                    return existingPc;
                }
                existingPc.close();
                peerConnections.delete(userId);
            }

            log(`üîå Creating peer connection with ${userId.substring(0,8)}`, 'info');
            const pc = new RTCPeerConnection(iceServers);
            peerConnections.set(userId, pc);

            let relayFound = false;

            // Add local tracks
            const streamToUse = isScreenSharing && screenStream ? screenStream : localStream;
            if (streamToUse) {
                streamToUse.getTracks().forEach(track => {
                    try {
                        pc.addTrack(track, streamToUse);
                        log(`‚ûï Added ${track.kind} track`, 'success');
                    } catch (error) {
                        log(`‚ùå Failed to add ${track.kind}: ${error.message}`, 'error');
                    }
                });
            } else {
                log(`‚ö†Ô∏è No local stream available`, 'warning');
            }

            // Handle incoming tracks
            pc.ontrack = (event) => {
                const [stream] = event.streams;
                log(`üìπ Received ${event.track.kind} track from ${userId.substring(0,8)}`, 'success');
                
                setTimeout(() => {
                    const participant = participants.get(userId);
                    const isScreenShare = event.track.label.includes('screen') || event.track.label.includes('display');
                    
                    if (isScreenShare) {
                        addVideoElement(userId + '-screen', stream, `${participant?.name || 'Unknown'} (Screen)`, false);
                    } else {
                        addVideoElement(userId, stream, participant?.name || 'Unknown', false);
                    }
                }, 300);
            };

            // Handle ICE candidates
            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    const c = event.candidate;
                    
                    if (c.type === 'relay') {
                        if (!relayFound) {
                            log(`   ‚úÖ TURN RELAY working! (${c.relayProtocol})`, 'success');
                            relayFound = true;
                        }
                    }
                    
                    const iceMessage = {
                        type: 'ice',
                        from: getMyUserId(),
                        to: userId,
                        candidate: c.candidate,
                        sdpMid: c.sdpMid,
                        sdpMLineIndex: c.sdpMLineIndex,
                        meeting_id: currentMeetingId
                    };
                    
                    log(`üßä Sending ICE: ${c.candidate.substring(0, 50)}...`, 'info');
                    sendSignalingMessage(iceMessage);
                } else {
                    log(`‚úÖ ICE gathering complete for ${userId.substring(0,8)}`, 'success');
                }
            };

            // Connection state monitoring
            pc.oniceconnectionstatechange = () => {
                const state = pc.iceConnectionState;
                const shortId = userId.substring(0, 8);
                log(`üîå ${shortId} ICE: ${state}`, 
                    state === 'connected' ? 'success' : 
                    state === 'failed' ? 'error' : 'info');
                
                if (state === 'failed') {
                    log(`üîÑ ICE failed for ${shortId}, attempting restart...`, 'warning');
                    setTimeout(() => {
                        if (pc.iceConnectionState === 'failed') {
                            pc.restartIce();
                        }
                    }, 2000);
                }
            };

            pc.onconnectionstatechange = () => {
                log(`üîó ${userId.substring(0,8)} connection: ${pc.connectionState}`, 'info');
            };

            monitorConnectionHealth();
            return pc;
        }

        async function makeOffer(userId) {
            try {
                log(`üì§ Making offer to ${userId.substring(0,8)}`, 'info');
                const pc = await createPeerConnection(userId);
                
                const offer = await pc.createOffer({
                    offerToReceiveAudio: true,
                    offerToReceiveVideo: true
                });
                
                await pc.setLocalDescription(offer);

                sendSignalingMessage({
                    type: 'offer',
                    from: getMyUserId(),
                    to: userId,
                    sdp: offer.sdp,
                    meeting_id: currentMeetingId 
                });

                log(`‚úÖ Offer sent to ${userId.substring(0,8)}`, 'success');
            } catch (error) {
                log(`‚ùå Error making offer: ${error.message}`, 'error');
            }
        }

        async function handleOffer(from, sdp, meetingId) {
            try {
                if (!isValidMeeting(meetingId)) {
                    log(`‚ö†Ô∏è Ignoring offer from different meeting: ${meetingId}`, 'warning');
                    return;
                }
                
                log(`üì® Received offer from ${from.substring(0,8)} in meeting ${meetingId}`, 'info');
                const pc = await createPeerConnection(from);
                
                // ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ≠ÿßŸÑÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ©
                if (pc.signalingState !== 'stable') {
                    log(`‚ö†Ô∏è PeerConnection not stable, current state: ${pc.signalingState}`, 'warning');
                    // ŸäŸÖŸÉŸÜŸÉ ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÄ PeerConnection ŸáŸÜÿß ÿ•ÿ∞ÿß ŸÑÿ≤ŸÖ ÿßŸÑÿ£ŸÖÿ±
                }
                
                await pc.setRemoteDescription(new RTCSessionDescription({ type: 'offer', sdp }));
                log(`‚úÖ Remote description set`, 'success');
                
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);

                sendSignalingMessage({
                    type: 'answer',
                    from: getMyUserId(),
                    to: from,
                    sdp: answer.sdp,
                    meeting_id: currentMeetingId 
                });

                log(`‚úÖ Answer sent to ${from.substring(0,8)}`, 'success');
            } catch (error) {
                log(`‚ùå Error handling offer: ${error.message}`, 'error');
            }
        }

        async function handleAnswer(from, sdp, meetingId) {
            try {
                if (!isValidMeeting(meetingId)) {
                    log(`‚ö†Ô∏è Ignoring answer from different meeting: ${meetingId}`, 'warning');
                    return;
                }
                
                log(`üì® Received answer from ${from.substring(0,8)} in meeting ${meetingId}`, 'info');
                const pc = peerConnections.get(from);
                
                if (!pc) {
                    log(`‚ö†Ô∏è No peer connection found for answer`, 'warning');
                    return;
                }
                
                // ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ≠ÿßŸÑÿ© ŸÇÿ®ŸÑ setRemoteDescription
                if (pc.signalingState !== 'have-local-offer') {
                    log(`‚ö†Ô∏è Ignoring answer - wrong signaling state: ${pc.signalingState}`, 'warning');
                    return;
                }
                
                await pc.setRemoteDescription(new RTCSessionDescription({ type: 'answer', sdp }));
                log(`‚úÖ Remote description (answer) set successfully`, 'success');
            } catch (error) {
                log(`‚ùå Error handling answer: ${error.message}`, 'error');
            }
        }

        function parseIceCandidate(candidateStr, fallbackData = {}) {
            if (!candidateStr) {
                console.warn('parseIceCandidate: candidateStr is empty');
                return null;
            }
            
            // ‚úÖ DEBUG: ÿ≥ÿ¨ŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ŸÑŸÖÿ©
            console.log('parseIceCandidate input:', {
                candidateStr: candidateStr?.substring(0, 100),
                fallbackData: fallbackData
            });
            
            // ÿ•ÿ∞ÿß ŸÉÿßŸÜ JSON
            if (candidateStr.startsWith('{')) {
                try {
                    const parsed = JSON.parse(candidateStr);
                    console.log('parseIceCandidate: parsed as JSON', parsed);
                    return parsed;
                } catch (e) {
                    console.warn('parseIceCandidate: Failed to parse as JSON:', e);
                }
            }
            
            if (typeof candidateStr === 'string' && candidateStr.includes('candidate:')) {
                const result = {
                    candidate: candidateStr,
                    sdpMid: fallbackData.sdpMid || '0',
                    sdpMLineIndex: fallbackData.sdpMLineIndex || 0
                };
                console.log('parseIceCandidate: parsed as SDP string', result);
                return result;
            }
            
            console.warn('parseIceCandidate: Unknown candidate format', candidateStr);
            return null;
        }

        async function handleIceCandidate(from, candidateStr, meetingId, sdpMid, sdpMLineIndex) {
            try {
                if (!isValidMeeting(meetingId)) {
                    log(`‚ö†Ô∏è Ignoring ICE from different meeting: ${meetingId}`, 'warning');
                    return;
                }
                
                log(`üßä Received ICE from ${from.substring(0,8)} in meeting ${meetingId}`, 'info');
                const pc = peerConnections.get(from);
                
                if (!pc) {
                    log(`‚ö†Ô∏è No peer connection for ICE candidate from ${from.substring(0,8)}`, 'warning');
                    return;
                }
                
                // ‚úÖ FIX: ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑŸÖÿπÿßŸÖŸÑÿßÿ™ sdpMid Ÿà sdpMLineIndex ŸÖÿ®ÿßÿ¥ÿ±ÿ© ÿ®ÿØŸÑÿßŸã ŸÖŸÜ data
                const candidateData = parseIceCandidate(candidateStr, {
                    sdpMid: sdpMid || '',        // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ sdpMid ŸÖŸÜ ÿßŸÑŸÖÿπÿßŸÖŸÑÿßÿ™
                    sdpMLineIndex: sdpMLineIndex || 0  // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ sdpMLineIndex ŸÖŸÜ ÿßŸÑŸÖÿπÿßŸÖŸÑÿßÿ™
                });
                
                if (!candidateData) {
                    log(`‚ö†Ô∏è Invalid ICE candidate data from ${from.substring(0,8)}`, 'warning');
                    return;
                }
                
                await pc.addIceCandidate(new RTCIceCandidate(candidateData));
                log(`‚úÖ ICE candidate added successfully from ${from.substring(0,8)}`, 'success');
            } catch (error) {
                log(`‚ùå Error adding ICE candidate from ${from.substring(0,8)}: ${error.message}`, 'error');
            }
        }

        function isValidMeeting(meetingId) {
            if (!meetingId || !currentMeetingId) {
                log(`‚ö†Ô∏è Missing meeting ID: received=${meetingId}, current=${currentMeetingId}`, 'warning');
                return false;
            }
            return meetingId === currentMeetingId;
        }

        function sendSignalingMessage(message) {
            if (currentMeetingId && !message.meeting_id) {
                message.meeting_id = currentMeetingId;
            }
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(message));
            }
        }

        function addVideoElement(userId, stream, name, isLocal) {
            const grid = document.getElementById('videoGrid');
            
            const emptyState = grid.querySelector('.empty-state');
            if (emptyState) emptyState.remove();

            const existing = document.getElementById(`video-${userId}`);
            if (existing) existing.remove();

            log(`üé¨ Adding video for ${name}`, 'info');

            const container = document.createElement('div');
            container.className = 'video-container';
            container.id = `video-${userId}`;
            
            const video = document.createElement('video');
            video.srcObject = stream;
            video.autoplay = true;
            video.playsInline = true;
            video.muted = isLocal;
            if (!isLocal) {
                video.volume = 1.0;
            }

            video.onloadedmetadata = () => {
                log(`‚úÖ Video loaded for ${name}`, 'success');
            };

            const audioTracks = stream.getAudioTracks();
            const hasAudio = audioTracks.length > 0 && audioTracks[0].enabled;
            const isScreenShare = userId.includes('-screen');
            const participant = participants.get(userId.replace('-screen', ''));

            const overlay = document.createElement('div');
            overlay.className = 'video-overlay';
            overlay.innerHTML = `
                <div class="video-name">${name}</div>
                <div class="video-status">
                    ${isLocal ? '<span class="video-badge you">YOU</span>' : ''}
                    ${isScreenShare ? '<span class="video-badge sharing">üñ•Ô∏è SHARING</span>' : ''}
                    ${participant?.is_raised ? '<span class="video-badge raised-hand">‚úã RAISED</span>' : ''}
                    ${!hasAudio ? '<span class="video-badge muted">üé§ MUTED</span>' : '<span class="video-badge">üé§ ON</span>'}
                </div>
            `;

            container.appendChild(video);
            container.appendChild(overlay);
            grid.appendChild(container);
        }

        function removeVideoElement(userId) {
            const video = document.getElementById(`video-${userId}`);
            if (video) video.remove();

            const grid = document.getElementById('videoGrid');
            if (grid.children.length === 0) {
                grid.innerHTML = '<div class="empty-state"><svg fill="currentColor" viewBox="0 0 20 20"><path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z"/></svg><p>No video streams yet</p></div>';
            }
        }

        // Meeting Operations
        async function createMeeting() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('Please connect first!');
                return;
            }

            await initLocalStream();

            const message = {
                type: 'create_meeting',
                user_data: getUserData(),
                meeting_title: document.getElementById('meetingTitle').value,
                waiting_list: document.getElementById('waitingList').checked
            };

            ws.send(JSON.stringify(message));
            log('üì§ Creating meeting...', 'info');
        }

        async function joinMeeting() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('Please connect first!');
                return;
            }

            const meetingId = document.getElementById('meetingIdInput').value.trim();
            if (!meetingId) {
                alert('Please enter a meeting ID');
                return;
            }

            await initLocalStream();

            const message = {
                type: 'request_join_meeting',
                user_data: getUserData(),
                meeting_id: meetingId
            };

            ws.send(JSON.stringify(message));
            log('üì§ Requesting to join meeting...', 'info');
        }

        function leaveMeeting() {
            if (!currentMeetingId) {
                alert('You are not in a meeting');
                return;
            }

            const message = {
                type: 'leave_meeting',
                user_id: document.getElementById('userId').value,
                meeting_id: currentMeetingId
            };

            ws.send(JSON.stringify(message));
            log('üì§ Leaving meeting...', 'info');

            stopLocalStream();
            stopScreenShare();
            lowerHand();
            closeAllPeerConnections();
            resetMeetingState();
        }

        function stopLocalStream() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
                removeVideoElement(getMyUserId());
            }
        }

        function closeAllPeerConnections() {
            peerConnections.forEach((pc, userId) => {
                pc.close();
                removeVideoElement(userId);
                removeVideoElement(userId + '-screen');
            });
            peerConnections.clear();
        }

        function resetMeetingState() {
            currentMeetingId = null;
            participants.clear();
            joinRequests.clear();
            screenShareRequests.clear();
            raisedHands.clear();
            chatMessages = [];
            currentScreenSharer = null;
            isScreenSharing = false;
            isHandRaised = false;
            
            document.getElementById('meetingInfoPanel').style.display = 'none';
            document.getElementById('screenShareControls').style.display = 'none';
            document.getElementById('raiseHandControls').style.display = 'none';
            document.getElementById('chatControls').style.display = 'none';
            document.getElementById('screenShareRequestsPanel').style.display = 'none';
            document.getElementById('raiseHandPanel').style.display = 'none';
            document.getElementById('leaveBtn').disabled = true;
            document.getElementById('stopShareBtn').disabled = true;
            document.getElementById('requestShareBtn').disabled = false;
            document.getElementById('raiseHandBtn').disabled = false;
            document.getElementById('lowerHandBtn').disabled = true;
            
            updateParticipantsList();
            updateJoinRequestsList();
            updateScreenShareRequestsList();
            updateRaisedHandsList();
            updateChatMessages();
            resetFileState();
        }
 function updateChatMessages() {
            const chatMessagesEl = document.getElementById('chatMessages');
            chatMessagesEl.innerHTML = '';

            if (chatMessages.length === 0) {
                chatMessagesEl.innerHTML = '<div class="message system">No messages yet. Start the conversation!</div>';
                return;
            }

            chatMessages.forEach(msg => {
                const messageEl = document.createElement('div');
                messageEl.className = `message ${msg.isMe ? 'sent' : 'received'} ${msg.isPrivate ? 'private' : ''}`;
                
                let messageHTML = '';
                
                // Message header
                if (msg.isPrivate) {
                    messageHTML += `<div class="message-header">üîí ${msg.senderName} ${msg.isMe ? '(You)' : ''}</div>`;
                } else if (!msg.isMe) {
                    messageHTML += `<div class="message-header">${msg.senderName}</div>`;
                } else {
                    messageHTML += `<div class="message-header">You</div>`;
                }
                
                // Message content based on type
                if (msg.messageType === 'text') {
                    messageHTML += `<div class="message-content">${msg.content || '(Empty message)'}</div>`;
                } else {
                    const fullFileUrl = msg.fileUrl ? 
                        (msg.fileUrl.startsWith('http') ? msg.fileUrl : `https://localhost:7190${msg.fileUrl}`) : 
                        '#';
                    
                    messageHTML += `
                        <div class="message-content">
                            ${msg.content ? `<div style="margin-bottom: 8px;">${msg.content}</div>` : ''}
                            <div class="message-file">
                                <span style="font-size: 16px;">${messageTypeIcons[msg.messageType]}</span>
                                <div style="flex: 1;">
                                    <a href="${fullFileUrl}" target="_blank" download="${msg.fileName}" 
                                       style="display: block; text-decoration: none; color: inherit;">
                                        <strong>${msg.fileName || 'Download file'}</strong>
                                        <div style="font-size: 11px; opacity: 0.7; margin-top: 2px;">
                                            ${msg.messageType.charAt(0).toUpperCase() + msg.messageType.slice(1)} ‚Ä¢ Click to download
                                        </div>
                                    </a>
                                </div>
                                <button onclick="downloadFile('${fullFileUrl}', '${msg.fileName}')" 
                                        style="background: rgba(255,255,255,0.3); border: none; border-radius: 4px; 
                                               padding: 4px 8px; font-size: 10px; cursor: pointer; color: inherit;">
                                    ‚¨áÔ∏è
                                </button>
                            </div>
                        </div>
                    `;
                }
                
                // Message time
                messageHTML += `<div class="message-time" style="font-size: 10px; opacity: 0.7; margin-top: 5px;">
                    ${new Date(msg.sentAt).toLocaleTimeString()}
                </div>`;
                
                messageEl.innerHTML = messageHTML;
                chatMessagesEl.appendChild(messageEl);
            });

            // Scroll to bottom
            chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
        }


// ‚úÖ ÿ•ÿ∂ÿßŸÅÿ© ÿØÿßŸÑÿ© ŸÑÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÑŸÅÿßÿ™
  // Download file
        function downloadFile(fileUrl, fileName) {
            const link = document.createElement('a');
            link.href = fileUrl;
            link.download = fileName;
            link.target = '_blank';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            log(`üì• Downloading: ${fileName}`, 'info');
        }
  // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeSettings(); 
            initializeEventListeners();
            log('üöÄ WebSocket Test Client with Enhanced File Upload', 'success');
            log('üìÅ File upload system ready - files will auto-upload when selected', 'info');
            log('üí¨ Support for text, images, files, voice, and video messages', 'info');
        });

function updateMediaState() {
            const message = {
                type: 'camera_mic_action',
                user_data: getUserData(),
                meeting_id: currentMeetingId
            };

            ws.send(JSON.stringify(message));
        }

        function respondToJoinRequest(requestId, userId, approved) {
            const message = {
                type: 'respond_join_request',
                request_id: requestId,
                user_id: userId,
                approved: approved
            };

            ws.send(JSON.stringify(message));
            log(`üì§ ${approved ? 'Approving' : 'Declining'} join request...`, 'info');

            joinRequests.delete(requestId);
            updateJoinRequestsList();
        }

        // Message Handlers
        function handleMessage(data) {
            const effectiveMeetingId = data.meeting_id || currentMeetingId;
        
            if (!effectiveMeetingId) {
                log(`‚ö†Ô∏è Message without meeting_id: ${data.type}`, 'warning');
                // ÿßÿ≥ÿ™ŸÖÿ± ŸÅŸä ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ© ÿ®ÿØŸàŸÜ meeting_id
            }
        
            // ÿ£ÿ∂ŸÅ meeting_id ŸÑŸÑÿ®ŸäÿßŸÜÿßÿ™
            data.meeting_id = effectiveMeetingId;
        
            log(`üì® ${data.type} in meeting ${effectiveMeetingId}`, 'info');

            switch(data.type) {
                case 'meeting_setting':
                    handleMeetingSettings(data);
                    break;
                case 'meeting_settings_updated':  // Add this case
                            handleMeetingSettingsUpdated(data);
                            break;
                case 'welcome':
                    handleWelcome(data);
                    break;
                case 'join_request_pending':
                    log('‚è≥ Join request pending host approval', 'warning');
                    break;
                case 'join_request_notification':
                    handleJoinRequestNotification(data);
                    break;
                case 'join_request_declined':
                    log('‚ùå Your join request was declined', 'error');
                    break;
                case 'camera_mic_action':
                    handleCameraMicAction(data);
                    break;
                case 'user_left':
                    handleUserLeft(data);
                    break;
                case 'offer':
                    handleOffer(data.from, data.sdp, data.meeting_id);
                    break;
                case 'answer':
                    handleAnswer(data.from, data.sdp, data.meeting_id);
                    break;
                case 'ice':
                    handleIceCandidate(
                        data.from, 
                        data.candidate, 
                        data.meeting_id, 
                        data.sdpMid,      
                        data.sdpMLineIndex 
                    );
                    break;
                    
                // Screen Share Messages
                case 'screen_share_request':
                    handleScreenShareRequest(data);
                    break;
                case 'screen_share_accepted':
                    log('‚úÖ Screen share request approved! Starting screen share...', 'success');
                    startScreenSharing();
                    break;
                case 'screen_share_rejected':
                    log('‚ùå Screen share request was rejected', 'error');
                    break;
                case 'share_screen_started':
                    updateScreenShareStatus(data.user_data.id, true);
                    break;
                case 'share_screen_stopped':
                    updateScreenShareStatus(data.user_data.id, false);
                    break;
                    
                // Raise Hand Messages
                case 'raise_hand_notification':
                    handleRaiseHandNotification(data);
                    break;
                    
                // Chat Messages
                case 'message_received':
                    handleMessageReceived(data);
                    break;
                    
                case 'error':
                    log(`‚ùå Error: ${data.message} (${data.code})`, 'error');
                    break;
            }
        }

        function handleMeetingSettings(data) {
            currentMeetingId = data.meeting_id;
            console.log('Handling meeting settings...', data);
            console.log('Meeting ID set to:', currentMeetingId);
            document.getElementById('meetingIdInput').value = data.meeting_id;
            document.getElementById('currentMeetingTitle').textContent =
                document.getElementById('meetingTitle').value;
            // Meeting code
            document.getElementById('currentMeetingCode').textContent = '‚Äî';

            document.getElementById('currentMeetingId').textContent = data.meeting_id;
            document.getElementById('meetingInfoPanel').style.display = 'block';
            document.getElementById('screenShareControls').style.display = 'block';
            document.getElementById('raiseHandControls').style.display = 'block';
            document.getElementById('chatControls').style.display = 'block';
            document.getElementById('leaveBtn').disabled = false;

            log(`‚úÖ Meeting created! ID: ${data.meeting_id}`, 'success');
        }

        async function handleWelcome(data) {
            console.log("üîç [DEBUG] Welcome data received:", data);
            
            if (!currentMeetingId && data.meeting_info) {
                currentMeetingId = data.meeting_info.id;
                document.getElementById('currentMeetingTitle').textContent = data.meeting_info.title;
                document.getElementById('currentMeetingCode').textContent = 'N/A';
                document.getElementById('currentMeetingId').textContent = data.meeting_info.id;
                document.getElementById('meetingInfoPanel').style.display = 'block';
                document.getElementById('screenShareControls').style.display = 'block';
                document.getElementById('raiseHandControls').style.display = 'block';
                document.getElementById('chatControls').style.display = 'block';
                document.getElementById('leaveBtn').disabled = false;
            }
            // Handle meeting settings from welcome message
    if (data.meeting_settings) {
        currentMeetingSettings = data.meeting_settings;
        updateSettingsDisplay();
        applySettingsRestrictions();
        log('‚öôÔ∏è Meeting settings loaded', 'success');
    }

            participants.clear();
            
            if (data.participants && data.participants.length > 0) {
                console.log("üîç [DEBUG] Setting participants from backend:", data.participants);
                
                data.participants.forEach(p => {
                    console.log(`üîç [DEBUG] Adding participant: ${p.name}, IsHost: ${p.is_host}, ID: ${p.id}`);
                    participants.set(p.id, p);
                    
                    if (p.id !== getMyUserId() && !peerConnections.has(p.id)) {
                        log(`üë§ Connecting to: ${p.name}`, 'info');
                        setTimeout(() => makeOffer(p.id), 1000);
                    }
                });
            }

            const myUserId = getMyUserId();
            const myUserData = getUserData();
            
            if (!participants.has(myUserId)) {
                const meAsParticipant = {
                    id: myUserId,
                    name: myUserData.name,
                    is_host: myUserData.is_host,
                    camera_enabled: myUserData.camera_enabled,
                    mic_enabled: myUserData.mic_enabled,
                    image_url: myUserData.image_url
                };
                participants.set(myUserId, meAsParticipant);
                console.log("üîç [DEBUG] Added myself to participants:", meAsParticipant);
            }
// Update user role and permissions
    updateUserRole(myUserData);
            updateParticipantsList();
            updateChatParticipants();
            log(`‚úÖ Total participants: ${participants.size}`, 'success');
        }

        function handleJoinRequestNotification(data) {
            joinRequests.set(data.request_id, {
                id: data.request_id,
                user: data.user_data,
                meetingId: data.meeting_id
            });
            updateJoinRequestsList();
            log(`üîî New join request from ${data.user_data.name}`, 'warning');
        }

        function handleCameraMicAction(data) {
            if (participants.has(data.user_data.id)) {
                participants.set(data.user_data.id, data.user_data);
                updateParticipantsList();
                log(`üìπ ${data.user_data.name} updated media state`, 'info');
            }
        }

        function handleUserLeft(data) {
            participants.delete(data.user_id);
            updateParticipantsList();
            updateChatParticipants();
            
            const pc = peerConnections.get(data.user_id);
            if (pc) {
                pc.close();
                peerConnections.delete(data.user_id);
            }
            
            removeVideoElement(data.user_id);
            removeVideoElement(data.user_id + '-screen');
            log(`üëã User left the meeting`, 'warning');
            
            if (data.user_id === getMyUserId()) {
                resetMeetingState();
            }
        }

        // UI Updates
        function updateConnectionStatus(connected) {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');

            if (connected) {
                dot.classList.add('connected');
                text.textContent = 'Connected';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
            } else {
                dot.classList.remove('connected');
                text.textContent = 'Disconnected';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
            }
        }

        function enableButtons(enabled) {
            document.getElementById('createBtn').disabled = !enabled;
            document.getElementById('joinBtn').disabled = !enabled;
        }

        function updateParticipantsList() {
            const list = document.getElementById('participantsList');
            const count = document.getElementById('participantCount');
            
            // ‚úÖ ÿßŸÑÿπÿØÿØ ÿ®ŸäŸÉŸàŸÜ participants.size ŸÅŸÇÿ∑ (ŸÖÿ¥ +1)
            count.textContent = participants.size;

            if (participants.size === 0) {
                list.innerHTML = '<div class="empty-state"><svg fill="currentColor" viewBox="0 0 20 20"><path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/></svg><p>No participants yet</p></div>';
                return;
            }

            list.innerHTML = '';

            // ‚úÖ ÿ∂ŸäŸÅ ŸÉŸÑ ÿßŸÑŸÄ participants ŸÖŸÜ ÿßŸÑŸÄ Map (ÿ®ŸÖÿß ŸÅŸäŸáŸÖ ÿßŸÑŸÄ host ÿßŸÑÿ≠ŸÇŸäŸÇŸä)
            participants.forEach(p => {
                const isMe = p.id === getMyUserId();
                const card = document.createElement('div');
                card.className = 'participant-card';
                card.innerHTML = `
                    <div class="participant-avatar">${p.name.charAt(0).toUpperCase()}</div>
                    <div class="participant-info">
                        <div class="participant-name">${p.name}${isMe ? ' (You)' : ''}</div>
                        <div class="participant-status">
                            ${p.is_host ? '<span class="status-badge host">HOST</span>' : ''}
                            ${p.camera_enabled ? '<span class="status-badge active">üìπ CAM</span>' : '<span class="status-badge">üìπ OFF</span>'}
                            ${p.mic_enabled ? '<span class="status-badge active">üé§ MIC</span>' : '<span class="status-badge">üé§ OFF</span>'}
                            ${p.is_sharing ? '<span class="status-badge sharing">üñ•Ô∏è SHARING</span>' : ''}
                            ${p.is_raised ? '<span class="status-badge raised-hand">‚úã RAISED</span>' : ''}
                        </div>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        function updateJoinRequestsList() {
            const list = document.getElementById('joinRequestsList');
            const count = document.getElementById('requestCount');
            
            count.textContent = joinRequests.size;

            if (joinRequests.size === 0) {
                list.innerHTML = '<div class="empty-state"><svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z" clip-rule="evenodd"/></svg><p>No pending requests</p></div>';
                return;
            }

            list.innerHTML = '';
            joinRequests.forEach(req => {
                const card = document.createElement('div');
                card.className = 'join-request-card';
                card.innerHTML = `
                    <div><strong>${req.user.name}</strong> wants to join</div>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">${req.user.email || 'No email'}</div>
                    <div class="join-request-actions">
                        <button class="btn btn-success" onclick="respondToJoinRequest('${req.id}', '${req.user.id}', true)">‚úì Approve</button>
                        <button class="btn btn-danger" onclick="respondToJoinRequest('${req.id}', '${req.user.id}', false)">‚úó Decline</button>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        function log(message, type = 'info') {
            const consoleEl = document.getElementById('console');
            const line = document.createElement('div');
            line.className = `console-line ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            line.textContent = `[${timestamp}] ${message}`;
            consoleEl.appendChild(line);
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }

        function getUserData() {
            return {
                id: document.getElementById('userId').value,
                name: document.getElementById('userName').value,
                image_url: `https://ui-avatars.com/api/?name=${encodeURIComponent(document.getElementById('userName').value)}&background=667eea&color=fff`,
                is_host: document.getElementById('isHost').checked,
                token: 'test-token-' + Date.now(),
                camera_enabled: document.getElementById('cameraEnabled').checked,
                mic_enabled: document.getElementById('micEnabled').checked
            };
        }

        function debugState() {
            log('========== DEBUG INFO ==========', 'warning');
            log(`My User ID: ${getMyUserId()}`, 'info');
            log(`Meeting ID: ${currentMeetingId || 'Not in meeting'}`, 'info');
            log(`WebSocket: ${ws ? (ws.readyState === WebSocket.OPEN ? 'Connected' : 'Disconnected') : 'None'}`, 'info');
            log(`Local Stream: ${localStream ? 'Active' : 'None'}`, 'info');
            log(`Screen Sharing: ${isScreenSharing ? 'Active' : 'Inactive'}`, 'info');
            log(`Hand Raised: ${isHandRaised ? 'Yes' : 'No'}`, 'info');
            log(`Chat Messages: ${chatMessages.length}`, 'info');
            
            if (localStream) {
                log(`  Video: ${localStream.getVideoTracks().length} tracks`, 'info');
                log(`  Audio: ${localStream.getAudioTracks().length} tracks`, 'info');
            }
            
            if (screenStream) {
                log(`  Screen Video: ${screenStream.getVideoTracks().length} tracks`, 'info');
                log(`  Screen Audio: ${screenStream.getAudioTracks().length} tracks`, 'info');
            }
            
            log(`Participants: ${participants.size}`, 'info');
            log(`Peer Connections: ${peerConnections.size}`, 'info');
            log(`Current Screen Sharer: ${currentScreenSharer || 'None'}`, 'info');
            log(`Raised Hands: ${raisedHands.size}`, 'info');
            
            peerConnections.forEach((pc, userId) => {
                const shortId = userId.substring(0, 8);
                log(`  ${shortId}: ${pc.connectionState} (ICE: ${pc.iceConnectionState})`, 'info');
            });
            
            log(`ICE Servers configured: ${iceServers.iceServers.length}`, 'info');
            iceServers.iceServers.forEach((server, i) => {
                if (server.urls) {
                    const urls = Array.isArray(server.urls) ? server.urls : [server.urls];
                    log(`  [${i}] ${urls[0]}${urls.length > 1 ? ` (+${urls.length - 1} more)` : ''}`, 'info');
                }
            });
            
            log('================================', 'warning');
        }


        // Metting Settings 
        // Update settings from UI
function updateMeetingSettings() {
    if (!currentMeetingId) {
        alert('Please join a meeting first!');
        return;
    }

    if (!isHost) {
        alert('Only the host can update meeting settings!');
        return;
    }

    const message = {
        type: 'update_meeting_settings',
        meeting_id: currentMeetingId,
        user_id: getMyUserId(),
        waiting_list: document.getElementById('settingWaitingList').checked,
        enable_camera: document.getElementById('settingEnableCamera').checked,
        enable_mic: document.getElementById('settingEnableMic').checked,
        enable_raise_hand: document.getElementById('settingEnableRaiseHand').checked,
        enable_share_screen: document.getElementById('settingEnableScreenSharing').checked,
        enable_chat: document.getElementById('settingEnableChat').checked,
        allow_participants_to_unmute: document.getElementById('settingAllowUnmute').checked,
        mute_all_participants_on_entry: document.getElementById('settingMuteOnEntry').checked,
        max_participants: parseInt(document.getElementById('settingMaxParticipants').value)
    };

    ws.send(JSON.stringify(message));
    log('‚öôÔ∏è Updating meeting settings...', 'info');
    
    // Disable button temporarily to prevent spam
    const btn = document.getElementById('updateSettingsBtn');
    btn.disabled = true;
    btn.textContent = '‚è≥ Updating...';
    
    setTimeout(() => {
        btn.disabled = false;
        btn.textContent = 'üíæ Update Settings';
    }, 2000);
}

// Reset settings to default
function resetSettingsToDefault() {
    if (!isHost) {
        alert('Only the host can reset settings!');
        return;
    }

    if (!confirm('Reset all settings to default values?')) {
        return;
    }

    document.getElementById('settingWaitingList').checked = true;
    document.getElementById('settingEnableCamera').checked = true;
    document.getElementById('settingEnableMic').checked = true;
    document.getElementById('settingEnableRaiseHand').checked = true;
    document.getElementById('settingEnableScreenSharing').checked = true;
    document.getElementById('settingEnableChat').checked = true;
    document.getElementById('settingAllowUnmute').checked = true;
    document.getElementById('settingMuteOnEntry').checked = false;
    document.getElementById('settingMaxParticipants').value = 100;

    log('üîÑ Settings reset to default', 'info');
}

// Handle settings update from server
function handleMeetingSettingsUpdated(data) {
    if (data.settings) {
        currentMeetingSettings = data.settings;
        updateSettingsUI();
        updateSettingsDisplay();
        
        log(`‚öôÔ∏è Meeting settings updated by ${getUserNameById(data.updated_by) || 'host'}`, 'success');
        
        // Apply settings restrictions
        applySettingsRestrictions();
    }
}

// Update settings UI (for host)
function updateSettingsUI() {
    if (!currentMeetingSettings || !isHost) return;

    document.getElementById('settingWaitingList').checked = currentMeetingSettings.waiting_list;
    document.getElementById('settingEnableCamera').checked = currentMeetingSettings.enable_camera;
    document.getElementById('settingEnableMic').checked = currentMeetingSettings.enable_mic;
    document.getElementById('settingEnableRaiseHand').checked = currentMeetingSettings.enable_raise_hand;
    document.getElementById('settingEnableScreenSharing').checked = currentMeetingSettings.enable_share_screen;
    document.getElementById('settingEnableChat').checked = currentMeetingSettings.enable_chat;
    document.getElementById('settingAllowUnmute').checked = currentMeetingSettings.allow_participants_to_unmute;
    document.getElementById('settingMuteOnEntry').checked = currentMeetingSettings.mute_all_participants_on_entry;
    document.getElementById('settingMaxParticipants').value = currentMeetingSettings.max_participants;
}

// Update settings display (for all participants)
function updateSettingsDisplay() {
    const display = document.getElementById('settingsDisplay');
    
    if (!currentMeetingSettings) {
        display.innerHTML = '<div class="empty-state"><svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"/></svg><p>Meeting settings will appear here</p></div>';
        return;
    }

    const settings = currentMeetingSettings;
    
    display.innerHTML = `
        <div class="setting-item">
            <div class="setting-icon">üìπ</div>
            <div class="setting-label">Camera</div>
            <div class="setting-value ${settings.enable_camera ? 'enabled' : 'disabled'}">
                ${settings.enable_camera ? 'Enabled' : 'Disabled'}
            </div>
        </div>
        
        <div class="setting-item">
            <div class="setting-icon">üé§</div>
            <div class="setting-label">Microphone</div>
            <div class="setting-value ${settings.enable_mic ? 'enabled' : 'disabled'}">
                ${settings.enable_mic ? 'Enabled' : 'Disabled'}
            </div>
        </div>
        
        <div class="setting-item">
            <div class="setting-icon">‚úã</div>
            <div class="setting-label">Raise Hand</div>
            <div class="setting-value ${settings.enable_raise_hand ? 'enabled' : 'disabled'}">
                ${settings.enable_raise_hand ? 'Enabled' : 'Disabled'}
            </div>
        </div>
        
        <div class="setting-item">
            <div class="setting-icon">üñ•Ô∏è</div>
            <div class="setting-label">Screen Share</div>
            <div class="setting-value ${settings.enable_share_screen ? 'enabled' : 'disabled'}">
                ${settings.enable_share_screen ? 'Enabled' : 'Disabled'}
            </div>
        </div>
        
        <div class="setting-item">
            <div class="setting-icon">üí¨</div>
            <div class="setting-label">Chat</div>
            <div class="setting-value ${settings.enable_chat ? 'enabled' : 'disabled'}">
                ${settings.enable_chat ? 'Enabled' : 'Disabled'}
            </div>
        </div>
        
        <div class="setting-item">
            <div class="setting-icon">üö™</div>
            <div class="setting-label">Waiting Room</div>
            <div class="setting-value ${settings.waiting_list ? 'enabled' : 'disabled'}">
                ${settings.waiting_list ? 'Enabled' : 'Disabled'}
            </div>
        </div>
        
        <div class="setting-item">
            <div class="setting-icon">üë•</div>
            <div class="setting-label">Max Participants</div>
            <div class="setting-value">${settings.max_participants}</div>
        </div>
        
        <div class="setting-item">
            <div class="setting-icon">üîä</div>
            <div class="setting-label">Allow Unmute</div>
            <div class="setting-value ${settings.allow_participants_to_unmute ? 'enabled' : 'disabled'}">
                ${settings.allow_participants_to_unmute ? 'Yes' : 'No'}
            </div>
        </div>
        
        <div class="setting-item">
            <div class="setting-icon">üîá</div>
            <div class="setting-label">Mute on Entry</div>
            <div class="setting-value ${settings.mute_all_participants_on_entry ? 'enabled' : 'disabled'}">
                ${settings.mute_all_participants_on_entry ? 'Yes' : 'No'}
            </div>
        </div>
    `;
}

// Apply settings restrictions to UI
function applySettingsRestrictions() {
    if (!currentMeetingSettings) return;

    const settings = currentMeetingSettings;
    
    // Disable/enable features based on settings
    document.getElementById('raiseHandBtn').disabled = !settings.enable_raise_hand;
    document.getElementById('requestShareBtn').disabled = !settings.enable_share_screen;
    
    // Update chat controls
    const chatControls = document.getElementById('chatControls');
    if (chatControls) {
        chatControls.style.opacity = settings.enable_chat ? '1' : '0.5';
        document.getElementById('chatInput').disabled = !settings.enable_chat;
        document.querySelector('.chat-input button').disabled = !settings.enable_chat;
    }
    
    // Show/hide waiting room message
    if (settings.waiting_list && !isHost) {
        log('‚è≥ Waiting room is enabled - host must approve join requests', 'info');
    }
    
    // Log restrictions
    if (!settings.enable_raise_hand) {
        log('‚ö†Ô∏è Raise hand feature is disabled by host', 'warning');
    }
    if (!settings.enable_share_screen) {
        log('‚ö†Ô∏è Screen sharing is disabled by host', 'warning');
    }
    if (!settings.enable_chat) {
        log('‚ö†Ô∏è Chat is disabled by host', 'warning');
    }
}
// Update user role and permissions
function updateUserRole(userData) {
    isHost = userData.is_host;
    
    // Show/hide settings panels based on role
    const settingsPanel = document.getElementById('meetingSettingsPanel');
    const currentSettingsPanel = document.getElementById('currentSettingsPanel');
    
    if (isHost) {
        settingsPanel.style.display = 'block';
        currentSettingsPanel.style.display = 'none';
        log('üéØ You are the meeting host - you can modify settings', 'success');
    } else {
        settingsPanel.style.display = 'none';
        currentSettingsPanel.style.display = 'block';
        log('üë§ You are a participant - you can view settings only', 'info');
    }
}
function getUserNameById(userId) {
    const participant = participants.get(userId);
    return participant ? participant.name : null;
}

        function monitorConnectionHealth() {
            peerConnections.forEach((pc, userId) => {
                const shortId = userId.substring(0, 8);
                
                pc.onconnectionstatechange = () => {
                    const state = pc.connectionState;
                    log(`üîó ${shortId} connection: ${state}`, 
                        state === 'connected' ? 'success' : 
                        state === 'failed' ? 'error' : 'info');
                    
                    if (state === 'failed') {
                        log(`üîÑ Connection failed for ${shortId}, attempting to reconnect...`, 'warning');
                        setTimeout(() => {
                            if (participants.has(userId)) {
                                makeOffer(userId);
                            }
                        }, 2000);
                    }
                };

                pc.oniceconnectionstatechange = () => {
                    const state = pc.iceConnectionState;
                    log(`üîå ${shortId} ICE: ${state}`, 
                        state === 'connected' ? 'success' : 
                        state === 'failed' ? 'error' : 'info');
                };
            });
        }
        // ÿ•ÿ∂ÿßŸÅÿ© Ÿáÿ∞ÿß ÿßŸÑŸÉŸàÿØ ŸÅŸä ŸÜŸáÿßŸäÿ© ÿßŸÑŸÄ script
document.getElementById('messageType').addEventListener('change', function() {
    const messageType = this.value;
    const fileUpload = document.getElementById('fileUpload');
    const fileLabel = document.querySelector('.file-upload-label');
    const chatInput = document.getElementById('chatInput');
    
    if (messageType === 'file') {
        fileLabel.style.background = '#3498db';
        fileLabel.textContent = 'üìé Click to select file';
        chatInput.placeholder = 'Add a caption (optional)...';
    } else {
        fileLabel.style.background = '#95a5a6';
        fileLabel.textContent = 'üìé Attach File';
        chatInput.placeholder = 'Type your message...';
        
        // ‚úÖ FIX: ÿ™ŸÜÿ∏ŸäŸÅ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖŸÑŸÅ ŸÅŸÇÿ∑ ÿπŸÜÿØ ÿßŸÑÿ™ÿ∫ŸäŸäÿ± ŸÖŸÜ ŸÖŸÑŸÅ ÿ•ŸÑŸâ ŸÜÿµ
        if (selectedFile) {
            resetFileState();
        }
    }
});

// ÿßŸÑÿ≥ŸÖÿßÿ≠ ÿ®ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ© ÿ®ÿßŸÑÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ Enter
document.getElementById('chatInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendChatMessage();
    }
});

        // Initialize
        log('üöÄ WebSocket Test Client with Screen Sharing, Raise Hand & Chat', 'success');
        log('üí° TURN credentials will be fetched automatically', 'info');
        log('üîÑ Click "Reload TURN" to refresh credentials', 'info');
        log('üñ•Ô∏è Screen sharing features are now available!', 'success');
        log('‚úã Raise hand feature is now available!', 'success');
        log('üí¨ Chat system is now available!', 'success');
    </script>
</body>
</html>